# Deployment Strategy for Hugo Site (digitaldias.com)

Purpose: Move from manual ad‑hoc uploads of `public/` via Azure Storage Explorer to a repeatable, scriptable, CI‑friendly process that produces clean, deterministic builds and deploys only the correct artifacts.

## Deployment Targets
1. Azure Static Web Apps (recommended for automatic builds, global CDN, easy preview envs)
2. Azure Storage Static Website (`$web` container) – simple and cost‑effective

## Core Principles
- Always build from a clean state (delete `public/` before each production build)
- Never hand‑edit files in `public/`
- All deployable artifacts are ONLY those generated by `hugo --minify`
- Reproducibility: same commit → same output (fingerprinted assets ensure cache busting)

## Build Source & Paths
- Site root (where `hugo.toml` lives): `src/`
- Build command (production): `hugo --minify`
- Output directory: `src/public/`

## Pre‑Build Checklist
- [ ] `baseURL` in `hugo.toml` set to `https://digitaldias.com/` (no trailing slash issues beyond one)
- [ ] No `draft: true` posts needed for release
- [ ] Removed any stale experimental assets from `static/`
- [ ] Confirm fingerprinted CSS/JS generated (presence of `css/styles.min.*.css` & `js/main.min.*.js`)
- [ ] Run standard build: `hugo` (verify time + page count expected)

### Clean Build Commands (Bash / PowerShell)
```bash
# From repo root
cd src
rm -rf public
hugo --minify
```
```powershell
Set-Location src
Remove-Item -Recurse -Force public
hugo --minify
```

## What Gets Deployed
Only contents of `public/` after a clean build:
- HTML: `index.html`, section list pages, single blog posts
- XML: `sitemap.xml`, `index.xml` (RSS), taxonomy RSS feeds
- CSS: Fingerprinted bundles under `public/css/`
- JS: Fingerprinted bundles under `public/js/`
- Manifest & icons: `site.webmanifest`, favicons
- 404 page: `404.html`
- Robots + config: `robots.txt`, `staticwebapp.config.json` (if used by Azure Static Web Apps)

## DO NOT Deploy
- Source markdown files
- Layouts, partials, archetypes
- `assets/` raw files
- `.todo/` folder
- Node/npm caches (none currently) or Hugo caches (not part of `public/`)

## Option A: Azure Storage Static Website
### One‑Time Setup
1. Create Storage Account (Standard, General Purpose v2)
2. Enable Static Website: index = `index.html`, error = `404.html`
3. Note container name: `$web`
4. Configure CDN or Front Door later for global performance (optional)

### Upload Script (Bash)
```bash
ACCOUNT_NAME="digitaldias"
BUILD_DIR="src/public"
# Clean build
cd src && rm -rf public && hugo --minify && cd ..
# Upload all files
az storage blob upload-batch \
  --account-name "$ACCOUNT_NAME" \
  --source "$BUILD_DIR" \
  --destination '$web' \
  --overwrite
```

### Faster Incremental Sync (AzCopy)
```bash
ACCOUNT_NAME=digitaldias
SAS_TOKEN="?<your-sas-token>"  # generate limited lifetime SAS
SOURCE="$(pwd)/src/public"
DEST="https://$ACCOUNT_NAME.blob.core.windows.net/$web"
azcopy sync "$SOURCE" "$DEST$SAS_TOKEN" --delete-destination true
```

## Option B: Azure Static Web Apps (Recommended)
### Benefits
- Automatic builds on push
- Preview environments for pull requests
- Built‑in global distribution & SSL
- Simpler redeploy (no manual blob uploads)

### GitHub Actions Workflow (Example)
Create `.github/workflows/deploy.yml`:
```yaml
name: Deploy Hugo to Azure Static Web Apps
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
permissions:
  contents: read
  pull-requests: write
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.152.2'
          extended: true
      - name: Build
        working-directory: src
        run: hugo --minify
      - name: Deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          app_location: src/public
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
```

### Secrets & Config
- Generate `AZURE_STATIC_WEB_APPS_API_TOKEN` from Azure Portal → add to repo secrets
- Adjust `hugo-version` as needed
- If using custom output formats or functions later, ensure build path correct

## Validation After Deployment
- [ ] Open homepage in browser (no console errors)
- [ ] Check `sitemap.xml` accessible
- [ ] Validate `robots.txt` contents
- [ ] RSS feed loads (`/index.xml`, `/blog/index.xml`)
- [ ] Fingerprinted assets referenced (network tab shows hashed CSS/JS)
- [ ] 404 page served for invalid route
- [ ] Security headers present (CSP from partial applies only if host config supports; verify)

## Rollback Strategy
- Keep previous successful build zipped (`public-YYYYMMDD-HHMM.zip`)
- To rollback on Storage: upload archived version to `$web` overwriting
- To rollback on Static Web Apps: revert commit or redeploy older commit SHA

## Future Improvements
- Add automatic integrity checks (script computing SHA256 of key assets; log in CI)
- Dependency scanning (none now, but if adding modules) to ensure safe provenance
- Slack/Teams notification on successful deployment (optional)
- Lighthouse CI integration for performance gating
- Link checker step using a simple crawler before deploy

## Quick Manual Deploy (Minimal)
```bash
cd src
rm -rf public
hugo --minify
az storage blob upload-batch \
  --account-name digitaldias \
  --source public \
  --destination '$web' \
  --overwrite
```

## Common Pitfalls & Avoidance
| Pitfall | Prevention |
|---------|------------|
| Stale fingerprinted assets | Always clean `public/` before build |
| Wrong `baseURL` causing absolute link issues | Set `baseURL` correctly before production build |
| Draft posts missing | Run `hugo` without `-D` for production; review front matter |
| Accidental source upload | ONLY upload `public/` directory |
| CSP mismatch on Azure Static Web Apps | Validate headers; adjust SWA config or serve meta tags consistently |

## Deployment Checklist (Copy/Paste)
- [ ] `baseURL` correct
- [ ] Clean build performed
- [ ] Page count matches expectation
- [ ] No drafts unintentionally excluded/included
- [ ] Upload completes without errors
- [ ] Homepage, RSS, sitemap verified
- [ ] Console is clean
- [ ] Archive previous build (optional)

---
Last updated: 2025-11-20
